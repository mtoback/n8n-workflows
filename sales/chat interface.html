<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .chat-display {
            background: #f7f9fc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 120px;
            display: none;
        }

        .chat-display.active {
            display: block;
        }

        .chat-text {
            color: #2d3748;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .dropdown-group, .multiselect-group {
            margin-bottom: 20px;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        select[multiple] {
            min-height: 120px;
        }

        select[multiple] option {
            padding: 8px;
            margin: 2px 0;
        }

        select[multiple] option:checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .calendar-group {
            margin-bottom: 20px;
        }

        .calendar-container {
            background: #f7f9fc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header button {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }

        .calendar-month {
            font-weight: 600;
            color: #2d3748;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 12px;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .calendar-day:hover:not(.disabled):not(.empty) {
            border-color: #667eea;
            background: #f7fafc;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .calendar-day.disabled {
            color: #cbd5e0;
            cursor: not-allowed;
            background: #f7fafc;
        }

        .calendar-day.empty {
            border: none;
            cursor: default;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .time-slot.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-container {
            margin-top: 10px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            text-align: center;
            margin-top: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .validation-error {
            color: #c53030;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .start-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .start-button:hover {
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.4);
        }

        .loading {
            text-align: center;
            color: #718096;
            padding: 20px;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-section {
            background: #edf2f7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .config-section label {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .config-section input {
            margin-bottom: 0;
        }

        .config-section small {
            display: block;
            color: #718096;
            margin-top: 6px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1>ðŸ“§ Contact Us</h1>
        <p style="text-align: center; color: #4a5568; margin-bottom: 25px; font-size: 16px; line-height: 1.5;">Let's design a workflow that makes your business run smoother</p>
        
        <div id="startSection">
            <button class="start-button" onclick="startChat()">Start the Conversation</button>
        </div>

        <div id="chatDisplay" class="chat-display">
            <div id="chatText" class="chat-text"></div>
            <div id="inputContainer"></div>
            <button id="sendButton" onclick="sendResponse()" style="display: none;">Send</button>
            <button id="okButton" onclick="resetChat()" style="display: none; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); margin-top: 10px;">OK</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Loading...
        </div>

        <div id="error" class="error" style="display: none;"></div>
        
        <div id="resetSection" style="display: none; margin-top: 20px;">
            <button onclick="resetChat()" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">Reset Chat</button>
        </div>
    </div>

    <script>
        // CONFIGURATION: Change this to your n8n webhook URL
        const WEBHOOK_BASE_URL = 'https://n8n.srv1039449.hstgr.cloud/webhook';
        
        let currentNextUrl = null;
        let baseUrl = WEBHOOK_BASE_URL;
        let sessionId = null;
        let currentStage = 'start';
        let conversationData = {};

        async function startChat() {
            // Construct the chat URL
            const chatUrl = `${baseUrl}/chat-test`;

            showLoading(true);
            hideError();

            try {
                const response = await fetch(chatUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stage: 'start',
                        webhookUrl: baseUrl
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}. Response: ${errorText.substring(0, 200)}`);
                }

                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                if (!responseText || responseText.trim() === '') {
                    throw new Error('Empty response from webhook. Make sure the workflow is active and returning JSON.');
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}`);
                }
                
                // Store session info
                sessionId = data.sessionId;
                currentStage = data.stage;
                
                displayResponse(data);
                
                document.getElementById('startSection').style.display = 'none';
                document.getElementById('resetSection').style.display = 'block';
            } catch (error) {
                showError(`Failed to start chat: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function resetChat() {
            // Reset the UI
            document.getElementById('chatDisplay').classList.remove('active');
            document.getElementById('startSection').style.display = 'block';
            document.getElementById('resetSection').style.display = 'none';
            document.getElementById('sendButton').style.display = 'none';
            document.getElementById('okButton').style.display = 'none';
            document.getElementById('inputContainer').innerHTML = '';
            hideError();
            
            // Reset session data
            sessionId = null;
            currentStage = 'start';
            conversationData = {};
            currentNextUrl = null;
        }

        async function sendResponse() {
            const inputContainer = document.getElementById('inputContainer');
            let responseValue = null;

            // Get the response value based on input type
            const textInput = inputContainer.querySelector('input[type="text"], input[type="email"], input[type="tel"]');
            const radioInputs = inputContainer.querySelectorAll('input[type="radio"]');
            const dropdown = inputContainer.querySelector('select:not([multiple])');
            const multiselect = inputContainer.querySelector('select[multiple]');
            const slider = inputContainer.querySelector('input[type="range"]');
            const calendar = inputContainer.querySelector('#calendar-container');

            if (textInput) {
                responseValue = textInput.value.trim();
                if (!responseValue) {
                    showError('Please enter a value');
                    return;
                }
                
                // Validate regex if provided
                if (textInput.dataset.regex) {
                    const regex = new RegExp(textInput.dataset.regex);
                    const errorDiv = document.getElementById('validation-error');
                    
                    if (!regex.test(responseValue)) {
                        if (errorDiv) {
                            errorDiv.textContent = textInput.dataset.errorMessage;
                            errorDiv.classList.add('show');
                        }
                        return;
                    } else {
                        if (errorDiv) {
                            errorDiv.classList.remove('show');
                        }
                    }
                }
                
            } else if (radioInputs.length > 0) {
                const selectedRadio = inputContainer.querySelector('input[type="radio"]:checked');
                if (!selectedRadio) {
                    showError('Please select an option');
                    return;
                }
                responseValue = selectedRadio.value;
                
            } else if (dropdown) {
                responseValue = dropdown.value;
                if (!responseValue) {
                    showError('Please select an option');
                    return;
                }
                
            } else if (multiselect) {
                const selectedOptions = Array.from(multiselect.selectedOptions).map(opt => opt.value);
                const minSelections = parseInt(multiselect.dataset.minSelections) || 0;
                const maxSelections = parseInt(multiselect.dataset.maxSelections) || Infinity;
                const errorDiv = document.getElementById('multiselect-error');
                
                if (selectedOptions.length < minSelections) {
                    if (errorDiv) {
                        errorDiv.textContent = `Please select at least ${minSelections} option${minSelections > 1 ? 's' : ''}`;
                        errorDiv.classList.add('show');
                    }
                    return;
                } else if (selectedOptions.length > maxSelections) {
                    if (errorDiv) {
                        errorDiv.textContent = `Please select no more than ${maxSelections} option${maxSelections > 1 ? 's' : ''}`;
                        errorDiv.classList.add('show');
                    }
                    return;
                } else {
                    if (errorDiv) {
                        errorDiv.classList.remove('show');
                    }
                }
                
                responseValue = selectedOptions; // Array of values
                
            } else if (slider) {
                responseValue = slider.value;
                
            } else if (calendar) {
                const selectedDate = calendar.dataset.selectedDate;
                const selectedTime = calendar.dataset.selectedTime;
                
                if (!selectedDate) {
                    showError('Please select a date');
                    return;
                }
                
                const timeSlots = JSON.parse(calendar.dataset.timeSlots || '[]');
                if (timeSlots.length > 0 && !selectedTime) {
                    showError('Please select a time slot');
                    return;
                }
                
                responseValue = {
                    date: selectedDate,
                    time: selectedTime || null
                };
            }

            if (!currentNextUrl || currentNextUrl === 'finish') {
                return;
            }

            console.log('Sending to URL:', currentNextUrl);
            console.log('Sending response:', responseValue);
            console.log('Session ID:', sessionId);
            console.log('Current stage:', currentStage);
            console.log('Conversation data:', conversationData);

            showLoading(true);
            hideError();

            try {
                // Build the request payload with session and stage info
                const payload = {
                    stage: currentStage,
                    response: responseValue,
                    sessionId: sessionId,
                    webhookUrl: baseUrl,
                    ...conversationData  // Include any previous conversation data
                };

                const response = await fetch(currentNextUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}. Response: ${errorText.substring(0, 200)}`);
                }

                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                if (!responseText || responseText.trim() === '') {
                    throw new Error('Empty response from webhook. Make sure the workflow is active.');
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}`);
                }
                
                // Update session tracking
                if (data.sessionId) sessionId = data.sessionId;
                if (data.stage) currentStage = data.stage;
                if (data.userName) conversationData.userName = data.userName;
                
                displayResponse(data);
            } catch (error) {
                console.error('Full error:', error);
                showError(`Failed to send response: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function displayResponse(data) {
            const chatDisplay = document.getElementById('chatDisplay');
            const chatText = document.getElementById('chatText');
            const inputContainer = document.getElementById('inputContainer');
            const sendButton = document.getElementById('sendButton');
            const okButton = document.getElementById('okButton');
            const resetSection = document.getElementById('resetSection');

            chatDisplay.classList.add('active');
            chatText.textContent = data.text;
            currentNextUrl = data.nextUrl;

            // Clear previous input
            inputContainer.innerHTML = '';

            if (data.nextUrl === 'finish' || !data.input) {
                // Conversation is finished
                sendButton.style.display = 'none';
                okButton.style.display = 'block';
                resetSection.style.display = 'none';
                return;
            }

            // Show reset button during conversation
            resetSection.style.display = 'block';
            okButton.style.display = 'none';

            // Render the appropriate input type
            if (data.input.type === 'text') {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';

                const input = document.createElement('input');
                input.type = data.input.inputType || 'text'; // Support email, tel, etc.
                input.placeholder = data.input.placeholder || '';
                input.id = 'text-input';
                
                // Store regex and error message if provided
                if (data.input.regex) {
                    input.dataset.regex = data.input.regex;
                    input.dataset.errorMessage = data.input.errorMessage || 'Invalid input format';
                }
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendResponse();
                    }
                });

                inputGroup.appendChild(input);
                
                // Add validation error div
                if (data.input.regex) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'validation-error';
                    errorDiv.id = 'validation-error';
                    inputGroup.appendChild(errorDiv);
                }
                
                inputContainer.appendChild(inputGroup);
                
                setTimeout(() => input.focus(), 100);
                
            } else if (data.input.type === 'radio') {
                const radioGroup = document.createElement('div');
                radioGroup.className = 'radio-group';

                data.input.options.forEach((option, index) => {
                    const radioOption = document.createElement('div');
                    radioOption.className = 'radio-option';

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'chatRadio';
                    radio.value = option.value;
                    radio.id = `radio-${index}`;

                    const label = document.createElement('label');
                    label.htmlFor = `radio-${index}`;
                    label.textContent = option.label;

                    radioOption.appendChild(radio);
                    radioOption.appendChild(label);
                    
                    radioOption.addEventListener('click', () => {
                        radio.checked = true;
                    });

                    radioGroup.appendChild(radioOption);
                });

                inputContainer.appendChild(radioGroup);
                
            } else if (data.input.type === 'dropdown') {
                const dropdownGroup = document.createElement('div');
                dropdownGroup.className = 'dropdown-group';

                const select = document.createElement('select');
                select.id = 'dropdown-select';
                
                // Add placeholder option
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = data.input.placeholder || 'Select an option...';
                placeholderOption.disabled = true;
                placeholderOption.selected = true;
                select.appendChild(placeholderOption);

                data.input.options.forEach((option) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    select.appendChild(optionElement);
                });

                dropdownGroup.appendChild(select);
                inputContainer.appendChild(dropdownGroup);
                
            } else if (data.input.type === 'multiselect') {
                const multiselectGroup = document.createElement('div');
                multiselectGroup.className = 'multiselect-group';

                const label = document.createElement('label');
                label.textContent = data.input.label || 'Select one or more options:';
                multiselectGroup.appendChild(label);

                const select = document.createElement('select');
                select.id = 'multiselect-select';
                select.multiple = true;
                
                // Store min/max selections
                if (data.input.minSelections) select.dataset.minSelections = data.input.minSelections;
                if (data.input.maxSelections) select.dataset.maxSelections = data.input.maxSelections;

                data.input.options.forEach((option) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    select.appendChild(optionElement);
                });

                multiselectGroup.appendChild(select);
                
                // Add validation error div for multiselect
                const errorDiv = document.createElement('div');
                errorDiv.className = 'validation-error';
                errorDiv.id = 'multiselect-error';
                multiselectGroup.appendChild(errorDiv);
                
                inputContainer.appendChild(multiselectGroup);
                
            } else if (data.input.type === 'slider') {
                const sliderGroup = document.createElement('div');
                sliderGroup.className = 'slider-group';

                const label = document.createElement('label');
                label.textContent = data.input.label || 'Select a value:';
                sliderGroup.appendChild(label);

                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'slider-container';

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.id = 'slider-input';
                slider.min = data.input.min || 0;
                slider.max = data.input.max || 100;
                slider.step = data.input.step || 1;
                slider.value = data.input.min || 0;

                const valueDisplay = document.createElement('div');
                valueDisplay.className = 'slider-value';
                const unit = data.input.unit || '';
                valueDisplay.textContent = `${slider.value} ${unit}`;

                slider.addEventListener('input', (e) => {
                    valueDisplay.textContent = `${e.target.value} ${unit}`;
                });

                sliderContainer.appendChild(slider);
                sliderContainer.appendChild(valueDisplay);
                sliderGroup.appendChild(sliderContainer);
                inputContainer.appendChild(sliderGroup);
                
            } else if (data.input.type === 'calendar') {
                const calendarGroup = document.createElement('div');
                calendarGroup.className = 'calendar-group';

                const label = document.createElement('label');
                label.textContent = data.input.label || 'Select a date:';
                calendarGroup.appendChild(label);

                const calendarContainer = document.createElement('div');
                calendarContainer.className = 'calendar-container';
                calendarContainer.id = 'calendar-container';

                // Store calendar data
                calendarContainer.dataset.minDate = data.input.minDate || '';
                calendarContainer.dataset.maxDate = data.input.maxDate || '';
                calendarContainer.dataset.disabledDays = JSON.stringify(data.input.disabledDays || []);
                calendarContainer.dataset.timeSlots = JSON.stringify(data.input.timeSlots || []);

                // Render calendar
                renderCalendar(calendarContainer, new Date());

                calendarGroup.appendChild(calendarContainer);
                inputContainer.appendChild(calendarGroup);
            }

            sendButton.style.display = 'block';
        }

        function renderCalendar(container, currentDate) {
            const minDate = container.dataset.minDate ? new Date(container.dataset.minDate) : null;
            const maxDate = container.dataset.maxDate ? new Date(container.dataset.maxDate) : null;
            const disabledDays = JSON.parse(container.dataset.disabledDays || '[]');
            const timeSlots = JSON.parse(container.dataset.timeSlots || '[]');

            container.innerHTML = '';

            // Header
            const header = document.createElement('div');
            header.className = 'calendar-header';

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â†';
            prevBtn.onclick = () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(container, currentDate);
            };

            const monthDisplay = document.createElement('div');
            monthDisplay.className = 'calendar-month';
            monthDisplay.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'â†’';
            nextBtn.onclick = () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(container, currentDate);
            };

            header.appendChild(prevBtn);
            header.appendChild(monthDisplay);
            header.appendChild(nextBtn);
            container.appendChild(header);

            // Calendar grid
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Empty cells before first day
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;

                // Check if day is disabled
                const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][date.getDay()];
                const isDisabledDay = disabledDays.includes(dayName);
                const isBeforeMin = minDate && date < minDate;
                const isAfterMax = maxDate && date > maxDate;

                if (isDisabledDay || isBeforeMin || isAfterMax) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.onclick = () => selectDate(container, date, timeSlots);
                }

                grid.appendChild(dayElement);
            }

            container.appendChild(grid);
        }

        function selectDate(container, date, timeSlots) {
            // Remove previous selection
            container.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
            
            // Mark selected day
            event.target.classList.add('selected');
            
            // Store selected date
            container.dataset.selectedDate = date.toISOString().split('T')[0];

            // Remove previous time slots
            const existingSlots = container.querySelector('.time-slots');
            if (existingSlots) existingSlots.remove();

            // Add time slots if provided
            if (timeSlots.length > 0) {
                const timeSlotsContainer = document.createElement('div');
                timeSlotsContainer.className = 'time-slots';

                timeSlots.forEach(time => {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.textContent = time;
                    slot.onclick = () => {
                        container.querySelectorAll('.time-slot.selected').forEach(el => el.classList.remove('selected'));
                        slot.classList.add('selected');
                        container.dataset.selectedTime = time;
                    };
                    timeSlotsContainer.appendChild(slot);
                });

                container.appendChild(timeSlotsContainer);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('sendButton').disabled = show;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
    </script>
</body>
</html>